<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magazzino Officina v26 - FULL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; 
            --dark: #2c3e50; --bg: #f4f7f6; --accent: #f39c12;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: var(--dark); }
        .sticky-header { position: sticky; top: 0; z-index: 100; background: var(--bg); padding-bottom: 10px; }
        .header { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .isola-selector { width: 100%; padding: 18px; border-radius: 10px; border: 4px solid var(--dark); background: var(--dark); color: white; font-weight: 800; font-size: 22px; margin-bottom: 12px; appearance: none; text-align: center; }
        input#cerca { width: 100%; padding: 18px; border: 4px solid var(--accent); border-radius: 10px; font-size: 22px; box-sizing: border-box; font-weight: bold; background: #fffde7; }
        
        .btn-toolbar { display: flex; gap: 8px; margin-top: 12px; }
        .btn-toolbar button { flex: 1; padding: 15px 5px; font-size: 13px; cursor: pointer; border-radius: 10px; border: none; background: #95a5a6; color: white; font-weight: 900; text-transform: uppercase; }
        .btn-sottoscorta { background: var(--danger) !important; }
        
        .cassetto-wrapper { margin-top: 15px; border-radius: 12px; overflow: hidden; background: white; border: 2px solid #ddd; }
        .cassetto-header { background: #5d6d7e; color: white; padding: 18px; display: flex; justify-content: space-between; font-size: 20px; font-weight: 900; }
        .cassetto-content { display: grid; padding: 12px; background: #ecf0f1; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        
        .card { background: white; border-radius: 12px; padding: 18px; position: relative; border-left: 12px solid var(--success); box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 320px; cursor: pointer; }
        .card.sottoscorta { border-left-color: var(--danger); background: #fff5f5; }
        
        .qty-container { position: absolute; top: 15px; right: 15px; text-align: right; }
        .qty-num { font-size: 42px; font-weight: 900; display: block; line-height: 0.9; }
        .qty-label { font-size: 14px; font-weight: 800; color: #666; }
        
        .card h4 { margin: 10px 0 15px 0; font-size: 1.4rem; color: var(--primary); text-transform: uppercase; padding-right: 85px; line-height: 1.1; font-weight: 800; }
        .cam-icon { font-size: 1.2rem; vertical-align: middle; margin-left: 5px; color: var(--accent); }

        .badge-code { display: block; padding: 8px 12px; border-radius: 6px; font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; border: 2px solid; }
        .b-int { background: #e8f4fd; color: #2980b9; border-color: #3498db; }
        .b-prod { background: #fdf2e9; color: #d35400; border-color: #e67e22; }
        
        .pos-label { font-size: 1.2rem; font-weight: 800; color: #444; margin-bottom: 15px; padding: 10px; background: #eee; border-radius: 8px; }
        
        .actions { display: flex; gap: 10px; margin-top: auto; }
        .actions button { flex: 1; padding: 22px 5px; border: none; border-radius: 10px; color: white; font-weight: 900; text-transform: uppercase; font-size: 18px; }
        
        #modal-foto { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
        #modal-foto img { max-width: 95%; max-height: 80%; border-radius: 10px; border: 4px solid white; object-fit: contain; }
        
        #sezione-storico { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto; padding-top: 70px; }
        .storico-header-fisso { position: fixed; top: 0; width: 100%; background: var(--dark); color: white; padding: 10px 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 2001; }
        #cerca-log { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .log-item { padding: 15px; border-bottom: 2px solid #eee; }
        .destinazione-badge { background: #34495e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; }
        .btn-chiudi-top { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 900; font-size: 18px; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header">
        <select id="select-isola" class="isola-selector" onchange="resetSearchAndFilter()">
            <optgroup label="ISOLE DI LAVORO">
                <option value="okuma fori">ğŸï¸ OKUMA FORI</option>
                <option value="okuma profili">ğŸï¸ OKUMA PROFILI</option>
                <option value="puma / dmg">ğŸï¸ PUMA / DMG</option>
                <option value="puma / okuma 45">ğŸï¸ PUMA / OKUMA 45</option>
                <option value="puma 600/ puma 700">ğŸï¸ PUMA 600 / 700</option>
                <option value="dmg / youji">ğŸï¸ DMG / YOUJI</option>
                <option value="ktm / youji">ğŸï¸ KTM / YOUJI</option>
                <option value="rettifiche fori">ğŸï¸ RETTIFICHE FORI</option>
                <option value="fastems">ğŸï¸ FASTEMS</option>
                <option value="rettifiche spessori">ğŸï¸ RETTIFICHE SPESSORI</option>
                <option value="tos hostivar">ğŸï¸ TOS HOSTIVAR</option>
                <option value="rv 1000/ bragonzi">ğŸï¸ RV 1000 / BRAGONZI</option>
                <option value="montaggio">ğŸï¸ MONTAGGIO</option>
                <option value="elettroerosioni">ğŸï¸ ELETTROEROSIONI</option>
                <option value="vtm100 / youji">ğŸï¸ VTM100 / YOUJI</option>
            </optgroup>
            <optgroup label="MAGAZZINI SPECIALI">
                <option value="olio esterno">ğŸšš OLIO ESTERNO FABBRICA</option>
                <option value="cassettiera ufficio">ğŸ“‚ CASSETTIERA UFFICIO</option>
                <option value="olii">ğŸ›¢ï¸ TUTTI GLI OLII (FILTRO)</option>
            </optgroup>
        </select>
        <input type="text" id="cerca" onkeyup="filtraTesto()" placeholder="ğŸ” CERCA ARTICOLO O CODICE...">
        <div class="btn-toolbar">
            <button onclick="apriStorico()" style="background: var(--dark);">ğŸ“œ STORICO</button>
            <button onclick="filtraSottoscorta()" class="btn-sottoscorta">ğŸš¨ SOTTOSCORTA</button>
            <button onclick="inizializza()">ğŸ”„ AGGIORNA</button>
        </div>
    </div>
</div>

<div id="elenco-materiale"></div>

<div id="sezione-storico">
    <div class="storico-header-fisso">
        <span style="font-weight:900; font-size:20px;">ğŸ“œ STORICO</span>
        <button class="btn-chiudi-top" onclick="document.getElementById('sezione-storico').style.display='none'">CHIUDI âœ•</button>
    </div>
    <div style="padding: 20px;">
        <input type="text" id="cerca-log" onkeyup="filtraStorico()" placeholder="ğŸ” Interroga lo storico (operatore, articolo, macchina)...">
        <div id="lista-log"></div>
    </div>
</div>

<div id="modal-foto" onclick="this.style.display='none'">
    <h3 id="titolo-foto" style="color:white; text-align:center; padding: 0 10px;"></h3>
    <img id="img-zoom" src="" alt="">
    <button style="margin-top:20px; padding:15px 40px; border-radius:10px; border:none; background:var(--danger); color:white; font-weight:bold;">CHIUDI</button>
</div>

<script>
    const S_URL = "https://yaflecdmyvamveenzfph.supabase.co";
    const S_KEY = "sb_publishable_YUNFFby__QxMgl4d_LdLvw_MS7IPGRV";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);
    let datiLocali = [];
    let logLocali = [];

    // ELENCO MACCHINE UFFICIALE
    const listaMacchine = [
        "20BG01 ALESATRICE BRAGONZI", "20DM03 DMG MORI CGV 9", "20DP01 PUMA 700 LY",
        "20DP02 VTR1216 M", "20DP04 VTR1216M", "20DW01 PUMA 600 PICIUL",
        "20DW02 PUMA 600 MARIO", "20JW01 JOVANKA", "20KD01 KTM",
        "20KY01 LASER KEYENCE", "20MO01 DMG NLX2500-700", "20MS01 MORI-SEIKI SL 65B",
        "20MT01 DMG MATE 55", "20MV01 MITSUBISHI MV2400", "20MV02 MITSUBISHI MV4800",
        "20OK04 VTM 100 PORFIDO", "20OK05 LB 35 PROFILI", "20OK06 LB 35 FORI 1",
        "20OK07 LB 35 FORI 2", "20OK08 OKUMA BIMANDRINO", "20OK10 OKUMA LB 45",
        "20OM04 OKAMOTO PRG8", "20RH01 TOS HOSTIVAR", "20RR01 STEFFORD RTR 1400",
        "20RR02 LODI RTR 4002", "20RV01 RV 1000", "20WT01 WOTAN S200",
        "20YO01 YOUJI YV 1200 PORFIDO", "20YO02 YOUJI YV 1200 FABIANO",
        "20YO03 YOUJI ROMUL", "20OK22 FASTEMS MC1", "20OK23 FASTEMS MC2", "20OK24 FASTEMS MC3"
    ];

    async function inizializza() {
        const { data, error } = await supabaseClient.from('utensili').select('*').order('cassetto', { ascending: true });
        if (!error) { datiLocali = data; renderizza(); }
    }

    function renderizza(datiFiltrati = null) {
        const cont = document.getElementById('elenco-materiale');
        cont.innerHTML = "";
        const selIsola = document.getElementById('select-isola').value.toLowerCase();
        const isFiltroAttivo = (datiFiltrati !== null);

        const sorgente = datiFiltrati || datiLocali.filter(item => {
            const isolaDB = (item.isola || "").toLowerCase().trim();
            if (selIsola === 'olii') return (item.cassetto || "").toUpperCase().includes("OLIO");
            return isolaDB === selIsola;
        });

        const gruppi = {};
        sorgente.forEach(u => {
            const chiave = isFiltroAttivo ? (u.isola || "VARIE").toUpperCase() : (u.cassetto || "NON DEFINITO").toUpperCase();
            if (!gruppi[chiave]) gruppi[chiave] = [];
            gruppi[chiave].push(u);
        });

        for (const [nome, prodotti] of Object.entries(gruppi)) {
            const wrapper = document.createElement('div');
            wrapper.className = 'cassetto-wrapper';
            wrapper.innerHTML = `<div class="cassetto-header"><span>${isFiltroAttivo ? 'ğŸï¸ ' : 'ğŸ“ '}${nome}</span> <span>${prodotti.length} ART.</span></div>`;
            const content = document.createElement('div');
            content.className = 'cassetto-content';
            
            prodotti.forEach(p => {
                const isLow = p.qty <= p.min;
                const card = document.createElement('div');
                card.className = `card ${isLow ? 'sottoscorta' : ''}`;
                card.onclick = (e) => { if (e.target.tagName !== 'BUTTON') apriFoto(p.img, p.desc); };
                const unit = (p.cassetto||"").toUpperCase().includes("OLIO") ? "Litri" : "Pezzi";
                
                card.innerHTML = `
                    <div class="qty-container" style="color:${isLow ? 'var(--danger)':'var(--success)'}">
                        <span class="qty-num">${Math.round(p.qty)}</span>
                        <span class="qty-label">${unit}</span>
                    </div>
                    <h4>${p.desc} ${p.img ? '<span class="cam-icon">ğŸ“·</span>' : ''}</h4>
                    <div class="badge-code b-int">INT: ${p.cod_int || '---'}</div>
                    <div class="badge-code b-prod">PROD: ${p.cod_prod || '---'}</div>
                    <div class="pos-label">ğŸ“¦ POS: ${p.cassetto || '---'}</div>
                    <div class="actions">
                        <button style="background:var(--primary)" onclick="event.stopPropagation(); movimento(${p.id}, '${p.desc.replace(/'/g, "\\'")}', ${p.qty}, 'scarico', '${p.isola}')">PRELEVA</button>
                        <button style="background:var(--success)" onclick="event.stopPropagation(); movimento(${p.id}, '${p.desc.replace(/'/g, "\\'")}', ${p.qty}, 'carico', '${p.isola}')">CARICA</button>
                    </div>`;
                content.appendChild(card);
            });
            wrapper.appendChild(content);
            cont.appendChild(wrapper);
        }
    }

    async function movimento(id, desc, attuale, tipo, isolaArticolo) {
        const chi = prompt("OPERATORE:"); if (!chi) return;
        const qtaVal = prompt("QUANTITÃ€:"); if (!qtaVal) return;
        const qta = parseInt(qtaVal); if (isNaN(qta)) return;

        let macchinaDestinazione = "MAGAZZINO";
        if (tipo === 'scarico') {
            let msg = "SELEZIONA MACCHINA (Inserisci il Numero):\n\n" + listaMacchine.map((m, i) => `${i + 1}. ${m}`).join("\n");
            const scelta = prompt(msg);
            const idx = parseInt(scelta) - 1;
            macchinaDestinazione = listaMacchine[idx] || "GENERICO";
        }

        const nuovaQty = tipo === 'scarico' ? attuale - qta : attuale + qta;
        const { error } = await supabaseClient.from('utensili').update({ qty: nuovaQty }).eq('id', id);
        if (!error) {
            await supabaseClient.from('log_movimenti').insert([{ 
                operatore: chi.toUpperCase(), articolo: desc, quantita: tipo === 'scarico' ? -qta : qta, 
                isola: isolaArticolo, macchina: macchinaDestinazione.toUpperCase() 
            }]);
            inizializza();
        }
    }

    async function apriStorico() {
        const { data } = await supabaseClient.from('log_movimenti').select('*').order('created_at', { ascending: false }).limit(100);
        logLocali = data;
        mostraLog(logLocali);
        document.getElementById('sezione-storico').style.display = 'block';
    }

    function mostraLog(dati) {
        const lista = document.getElementById('lista-log');
        lista.innerHTML = dati.map(l => `
            <div class="log-item">
                <strong>${l.operatore}</strong>: ${l.quantita > 0 ? 'ğŸ“¥' : 'ğŸ“¤'} ${Math.abs(l.quantita)} - ${l.articolo}<br>
                <span class="destinazione-badge">ğŸ“ ${l.isola || '---'}</span> 
                ${l.macchina ? `<span class="destinazione-badge" style="background:#e67e22">âš™ï¸ ${l.macchina}</span>` : ''}
                <br><small style="color:#888">${new Date(l.created_at).toLocaleString()}</small>
            </div>
        `).join('');
    }

    function filtraStorico() {
        const t = document.getElementById('cerca-log').value.toLowerCase();
        mostraLog(logLocali.filter(l => (l.operatore+l.articolo+l.macchina).toLowerCase().includes(t)));
    }

    function filtraSottoscorta() { renderizza(datiLocali.filter(u => u.qty <= u.min)); }
    function filtraTesto() {
        const t = document.getElementById('cerca').value.toLowerCase().trim();
        if (!t) { renderizza(); return; }
        renderizza(datiLocali.filter(u => (u.desc+u.cod_int+u.cod_prod+u.isola).toLowerCase().includes(t)));
    }
    function resetSearchAndFilter() { document.getElementById('cerca').value = ""; renderizza(); }
    function apriFoto(url, titolo) {
        if (!url) return;
        document.getElementById('img-zoom').src = url;
        document.getElementById('titolo-foto').innerText = titolo;
        document.getElementById('modal-foto').style.display = 'flex';
    }

    inizializza();
</script>
</body>
</html>
