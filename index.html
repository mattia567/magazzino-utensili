<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magazzino Officina v30 - Vista Lista</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #3498db; --danger: #e74c3c; --success: #2ecc71; 
            --dark: #2c3e50; --bg: #f4f7f6; --accent: #f39c12;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; color: var(--dark); }
        
        /* HEADER FISSO */
        .sticky-header { position: sticky; top: 0; z-index: 100; background: var(--bg); padding-bottom: 10px; }
        .header { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .isola-selector { width: 100%; padding: 15px; border-radius: 10px; border: 3px solid var(--dark); background: var(--dark); color: white; font-weight: 800; font-size: 20px; margin-bottom: 10px; appearance: none; text-align: center; }
        input#cerca { width: 100%; padding: 15px; border: 3px solid var(--accent); border-radius: 10px; font-size: 18px; box-sizing: border-box; font-weight: bold; }
        
        .btn-toolbar { display: flex; gap: 8px; margin-top: 10px; }
        .btn-toolbar button { flex: 1; padding: 12px 5px; font-size: 12px; cursor: pointer; border-radius: 8px; border: none; background: #95a5a6; color: white; font-weight: 900; text-transform: uppercase; }

        /* STRUTTURA LISTA */
        .cassetto-wrapper { margin-top: 15px; border-radius: 12px; overflow: hidden; background: white; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cassetto-header { background: #5d6d7e; color: white; padding: 12px 18px; display: flex; justify-content: space-between; font-size: 18px; font-weight: 900; }
        .cassetto-content { display: flex; flex-direction: column; }

        /* RIGA ARTICOLO (COMPATTA) */
        .riga-articolo { 
            display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; 
            gap: 15px; position: relative; cursor: pointer;
        }
        .riga-articolo:last-child { border-bottom: none; }
        .riga-articolo.sottoscorta { background: #fff5f5; border-left: 8px solid var(--danger); }
        .riga-articolo:not(.sottoscorta) { border-left: 8px solid var(--success); }

        .col-info { flex: 1; min-width: 0; }
        .col-info h4 { margin: 0 0 4px 0; font-size: 1.1rem; text-transform: uppercase; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .codici-line { font-size: 0.85rem; color: #666; font-weight: 600; display: flex; gap: 10px; }
        
        .col-qty { text-align: center; min-width: 60px; }
        .qty-num { font-size: 28px; font-weight: 900; display: block; line-height: 1; }
        .qty-unit { font-size: 10px; font-weight: 800; color: #888; text-transform: uppercase; }

        .col-actions { display: flex; gap: 8px; }
        .btn-azione { 
            width: 50px; height: 50px; border: none; border-radius: 8px; color: white; 
            font-size: 22px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* MODALI */
        #modal-foto, #modal-macchine, #sezione-storico { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; }
        #modal-foto, #modal-macchine { background: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; }
        .modal-content-macchine { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 15px; padding: 20px; overflow-y: auto; }
        .lista-bottoni-macchine { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 15px; }
        .btn-macchina { padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #f8f9fa; font-weight: bold; text-align: left; font-size: 16px; }
        
        /* STORICO */
        #sezione-storico { background: white; overflow-y: auto; padding-top: 60px; }
        .storico-header-fisso { position: fixed; top: 0; width: 100%; background: var(--dark); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 5001; height: 60px; box-sizing: border-box; }
        .log-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .log-badge { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header">
        <select id="select-isola" class="isola-selector" onchange="resetSearchAndFilter()">
            <optgroup label="ISOLE DI LAVORO">
                <option value="okuma fori">üèùÔ∏è OKUMA FORI</option>
                <option value="okuma profili">üèùÔ∏è OKUMA PROFILI</option>
                <option value="puma / dmg">üèùÔ∏è PUMA / DMG</option>
                <option value="puma / okuma 45">üèùÔ∏è PUMA / OKUMA 45</option>
                <option value="puma 600/ puma 700">üèùÔ∏è PUMA 600 / 700</option>
                <option value="dmg / youji">üèùÔ∏è DMG / YOUJI</option>
                <option value="ktm / youji">üèùÔ∏è KTM / YOUJI</option>
                <option value="rettifiche fori">üèùÔ∏è RETTIFICHE FORI</option>
                <option value="fastems">üèùÔ∏è FASTEMS</option>
                <option value="rettifiche spessori">üèùÔ∏è RETTIFICHE SPESSORI</option>
                <option value="tos hostivar">üèùÔ∏è TOS HOSTIVAR</option>
                <option value="rv 1000/ bragonzi">üèùÔ∏è RV 1000 / BRAGONZI</option>
                <option value="montaggio">üèùÔ∏è MONTAGGIO</option>
                <option value="elettroerosioni">üèùÔ∏è ELETTROEROSIONI</option>
                <option value="vtm100 / youji">üèùÔ∏è VTM100 / YOUJI</option>
            </optgroup>
            <optgroup label="MAGAZZINI SPECIALI">
                <option value="olio esterno">üöö OLIO ESTERNO FABBRICA</option>
                <option value="cassettiera ufficio">üìÇ CASSETTIERA UFFICIO</option>
                <option value="olii">üõ¢Ô∏è TUTTI GLI OLII (FILTRO)</option>
            </optgroup>
        </select>
        <input type="text" id="cerca" onkeyup="filtraTesto()" placeholder="üîç Cerca articolo o codice...">
        <div class="btn-toolbar">
            <button onclick="apriStorico()" style="background: var(--dark);">üìú STORICO</button>
            <button onclick="filtraSottoscorta()" style="background: var(--danger);">üö® SOTTOSCORTA</button>
            <button onclick="inizializza()">üîÑ AGGIORNA</button>
        </div>
    </div>
</div>

<div id="elenco-materiale"></div>

<div id="modal-macchine">
    <div class="modal-content-macchine">
        <h2 style="text-align:center; margin:0 0 15px 0;">DESTINAZIONE?</h2>
        <div class="lista-bottoni-macchine" id="lista-bottoni-macchine"></div>
        <button onclick="chiudiModalMacchina()" style="width:100%; margin-top:15px; padding:15px; border:none; border-radius:8px; font-weight:bold; background:#eee;">ANNULLA</button>
    </div>
</div>

<div id="modal-foto" onclick="this.style.display='none'">
    <h3 id="titolo-foto" style="color:white; text-align:center;"></h3>
    <img id="img-zoom" src="" style="max-width:90%; max-height:70%; border:3px solid white; border-radius:10px;">
    <p style="color:white; font-weight:bold; margin-top:20px;">TOCCA PER CHIUDERE</p>
</div>

<div id="sezione-storico">
    <div class="storico-header-fisso">
        <span style="font-weight:900;">üìú STORICO</span>
        <button onclick="document.getElementById('sezione-storico').style.display='none'" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:5px; font-weight:bold;">X</button>
    </div>
    <div style="padding: 15px;">
        <input type="text" id="cerca-log" onkeyup="filtraStorico()" placeholder="üîç Cerca operatore, macchina o codici..." style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px;">
        <div id="lista-log"></div>
    </div>
</div>

<script>
    const S_URL = "https://yaflecdmyvamveenzfph.supabase.co";
    const S_KEY = "sb_publishable_YUNFFby__QxMgl4d_LdLvw_MS7IPGRV";
    const supabaseClient = supabase.createClient(S_URL, S_KEY);
    
    let datiLocali = [];
    let logLocali = [];
    let movimentoCorrente = null;

    const listaMacchine = [
        "20BG01 ALESATRICE BRAGONZI", "20DM03 DMG MORI CGV 9", "20DP01 PUMA 700 LY",
        "20DP02 VTR1216 M", "20DP04 VTR1216M", "20DW01 PUMA 600 PICIUL",
        "20DW02 PUMA 600 MARIO", "20JW01 JOVANKA", "20KD01 KTM",
        "20KY01 LASER KEYENCE", "20MO01 DMG NLX2500-700", "20MS01 MORI-SEIKI SL 65B",
        "20MT01 DMG MATE 55", "20MV01 MITSUBISHI MV2400", "20MV02 MITSUBISHI MV4800",
        "20OK04 VTM 100 PORFIDO", "20OK05 LB 35 PROFILI", "20OK06 LB 35 FORI 1",
        "20OK07 LB 35 FORI 2", "20OK08 OKUMA BIMANDRINO", "20OK10 OKUMA LB 45",
        "20OM04 OKAMOTO PRG8", "20RH01 TOS HOSTIVAR", "20RR01 STEFFORD RTR 1400",
        "20RR02 LODI RTR 4002", "20RV01 RV 1000", "20WT01 WOTAN S200",
        "20YO01 YOUJI YV 1200 PORFIDO", "20YO02 YOUJI YV 1200 FABIANO",
        "20YO03 YOUJI ROMUL", "20OK22 FASTEMS MC1", "20OK23 FASTEMS MC2", "20OK24 FASTEMS MC3",
        "MAGAZZINO / ALTRO"
    ];

    async function inizializza() {
        const { data, error } = await supabaseClient.from('utensili').select('*').order('cassetto', { ascending: true });
        if (!error) { datiLocali = data; renderizza(); }
    }

    function renderizza(datiFiltrati = null) {
        const cont = document.getElementById('elenco-materiale');
        cont.innerHTML = "";
        const selIsola = document.getElementById('select-isola').value.toLowerCase();
        
        const sorgente = datiFiltrati || datiLocali.filter(item => {
            const isolaDB = (item.isola || "").toLowerCase().trim();
            if (selIsola === 'olii') return (item.cassetto || "").toUpperCase().includes("OLIO");
            return isolaDB === selIsola;
        });

        const gruppi = {};
        sorgente.forEach(u => {
            const chiave = (u.cassetto || "VARIE").toUpperCase().trim();
            if (!gruppi[chiave]) gruppi[chiave] = [];
            gruppi[chiave].push(u);
        });

        for (const [nome, prodotti] of Object.entries(gruppi)) {
            const wrapper = document.createElement('div');
            wrapper.className = 'cassetto-wrapper';
            wrapper.innerHTML = `<div class="cassetto-header"><span>üìç ${nome}</span> <span>${prodotti.length}</span></div>`;
            const content = document.createElement('div');
            content.className = 'cassetto-content';
            
            prodotti.forEach(p => {
                const isLow = p.qty <= p.min;
                const riga = document.createElement('div');
                riga.className = `riga-articolo ${isLow ? 'sottoscorta' : ''}`;
                riga.onclick = (e) => { if (!e.target.closest('button')) apriFoto(p.img, p.desc); };
                
                riga.innerHTML = `
                    <div class="col-info">
                        <h4>${p.desc} ${p.img ? 'üì∑' : ''}</h4>
                        <div class="codici-line">
                            <span>INT: ${p.cod_int || '-'}</span>
                            <span>PROD: ${p.cod_prod || '-'}</span>
                        </div>
                    </div>
                    <div class="col-qty">
                        <span class="qty-num" style="color:${isLow ? 'var(--danger)' : 'var(--success)'}">${Math.round(p.qty)}</span>
                        <span class="qty-unit">${(p.cassetto||'').includes('OLIO') ? 'Litri' : 'Pz'}</span>
                    </div>
                    <div class="col-actions">
                        <button class="btn-azione" style="background:var(--primary)" onclick="avviaMovimento(${p.id}, '${p.desc.replace(/'/g, "\\'")}', ${p.qty}, 'scarico', '${p.isola}', '${p.cod_int}', '${p.cod_prod}')">‚àí</button>
                        <button class="btn-azione" style="background:var(--success)" onclick="avviaMovimento(${p.id}, '${p.desc.replace(/'/g, "\\'")}', ${p.qty}, 'carico', '${p.isola}', '${p.cod_int}', '${p.cod_prod}')">+</button>
                    </div>`;
                content.appendChild(riga);
            });
            wrapper.appendChild(content);
            cont.appendChild(wrapper);
        }
    }

    function avviaMovimento(id, desc, attuale, tipo, isola, cod_int, cod_prod) {
        const chi = prompt("OPERATORE:"); if (!chi) return;
        const qtaVal = prompt("QUANTIT√Ä:"); if (!qtaVal) return;
        const qta = parseInt(qtaVal); if (isNaN(qta)) return;
        movimentoCorrente = { id, desc, attuale, tipo, isola, chi, qta, cod_int, cod_prod };
        if (tipo === 'scarico') apriModalMacchina(); else eseguiSalvataggio("MAGAZZINO");
    }

    function apriModalMacchina() {
        const c = document.getElementById('lista-bottoni-macchine');
        c.innerHTML = "";
        listaMacchine.forEach(m => {
            const b = document.createElement('button');
            b.className = 'btn-macchina';
            b.innerText = m;
            b.onclick = () => eseguiSalvataggio(m);
            c.appendChild(b);
        });
        document.getElementById('modal-macchine').style.display = 'flex';
    }

    function chiudiModalMacchina() { document.getElementById('modal-macchine').style.display = 'none'; }

    async function eseguiSalvataggio(macchina) {
        chiudiModalMacchina();
        const { id, attuale, tipo, qta, chi, desc, isola, cod_int, cod_prod } = movimentoCorrente;
        const nuovaQty = tipo === 'scarico' ? attuale - qta : attuale + qta;
        const { error } = await supabaseClient.from('utensili').update({ qty: nuovaQty }).eq('id', id);
        if (!error) {
            await supabaseClient.from('log_movimenti').insert([{ 
                operatore: chi.toUpperCase(), articolo: desc, quantita: tipo === 'scarico' ? -qta : qta, 
                isola: isola, macchina: macchina.toUpperCase(), cod_int: cod_int, cod_prod: cod_prod 
            }]);
            inizializza();
        }
    }

    function apriFoto(url, titolo) {
        if (!url) return;
        document.getElementById('img-zoom').src = url;
        document.getElementById('titolo-foto').innerText = titolo;
        document.getElementById('modal-foto').style.display = 'flex';
    }

    async function apriStorico() {
        const { data } = await supabaseClient.from('log_movimenti').select('*').order('created_at', { ascending: false }).limit(100);
        logLocali = data;
        mostraLog(logLocali);
        document.getElementById('sezione-storico').style.display = 'block';
    }

    function mostraLog(d) {
        document.getElementById('lista-log').innerHTML = d.map(l => `
            <div class="log-item">
                <b>${l.operatore}</b>: ${l.quantita > 0 ? 'üì•' : 'üì§'} ${Math.abs(l.quantita)} ${l.articolo}<br>
                <div style="margin-top:4px;">
                    <span class="log-badge">INT: ${l.cod_int || '-'}</span>
                    <span class="log-badge" style="background:#fdebd0">MACC: ${l.macchina || '-'}</span>
                </div>
                <small style="color:#999">${new Date(l.created_at).toLocaleString()}</small>
            </div>
        `).join('');
    }

    function filtraStorico() {
        const t = document.getElementById('cerca-log').value.toLowerCase();
        mostraLog(logLocali.filter(l => (l.operatore+l.articolo+l.macchina+l.cod_int+l.cod_prod).toLowerCase().includes(t)));
    }

    function filtraSottoscorta() { renderizza(datiLocali.filter(u => u.qty <= u.min)); }
    function filtraTesto() {
        const t = document.getElementById('cerca').value.toLowerCase().trim();
        if(!t) { renderizza(); return; }
        renderizza(datiLocali.filter(u => (u.desc+u.cod_int+u.cod_prod).toLowerCase().includes(t)));
    }
    function resetSearchAndFilter() { document.getElementById('cerca').value = ""; renderizza(); }

    inizializza();
</script>
</body>
</html>
